FROM {{ .BaseImage }}

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PATH=/root/.local/bin:/opt/venv/bin:$PATH \
    KDEPS_BIND_HOST=0.0.0.0 \
    {{- if .InstallOllama }}
    OLLAMA_HOST=127.0.0.1 \
    OLLAMA_PORT={{ .BackendPort }} \
    OLLAMA_MODELS=/root/.ollama/models \
    {{- end }}
    BACKEND_PORT={{ .BackendPort }}
{{- if .Env }}

# User-defined environment variables
{{- range $key, $value := .Env }}
ENV {{ $key }}="{{ $value }}"
{{- end }}
{{- end }}

# Install base dependencies
RUN apk add --no-cache \
    zstd \
    python3 \
    py3-pip \
    curl \
    wget \
    bash \
    supervisor \
    ca-certificates \
    libstdc++ \
    rsync

# Install kdeps
RUN curl -LsSf https://raw.githubusercontent.com/kdeps/kdeps/main/install.sh | sh -s -- -b /usr/local/bin

{{- if .OSPackages }}

# Install OS packages
RUN apk add --no-cache{{ range .OSPackages }} {{ . }}{{ end }}
{{- end }}

# Install LLM backend
{{ .BackendInstall }}

{{- if .InstallUV }}

# Install uv for Python package management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
RUN chmod +x /usr/local/bin/uv

# Create virtual environment
RUN /usr/local/bin/uv venv /opt/venv
{{- end }}

{{- if .PythonPackages }}

# Install Python packages
RUN /usr/local/bin/uv pip install{{ range .PythonPackages }} {{ . }}{{ end }}
{{- end }}

{{- if .RequirementsFile }}

# Install from requirements file
COPY {{ .RequirementsFile }} /tmp/requirements.txt
RUN /usr/local/bin/uv pip install -r /tmp/requirements.txt
{{- end }}

# Copy workflow files
COPY workflow.yaml /app/workflow.yaml
{{- if .HasResources }}
COPY resources/ /app/resources/
{{- end }}
{{- if .HasData }}
COPY data/ /app/data/
{{- end }}

# Copy entrypoint and supervisor config
COPY entrypoint.sh /entrypoint.sh
COPY supervisord.conf /etc/supervisord.conf
RUN chmod +x /entrypoint.sh

# Ensure log directory exists
RUN mkdir -p /var/log

{{- if and .OfflineMode .Models .InstallOllama }}

# Download models during build time for offline mode
RUN mkdir -p /llm

# Download Ollama models
RUN (OLLAMA_HOST=127.0.0.1 /usr/local/bin/ollama serve &) && \
    sleep 10 && \
    {{- range $i, $model := .Models }}{{ if $i }} && \{{ end }}
    OLLAMA_HOST=127.0.0.1 /usr/local/bin/ollama pull {{ $model }}{{ end }} && \
    pkill -f ollama && \
    sleep 2 && \
    # Copy to the image layer
    cp -r /root/.ollama/* /llm/
{{- end }}

WORKDIR /app

# Expose ports
{{- if .HasAPIServer }}
EXPOSE {{ .APIPort }}
{{- end }}
{{- if .HasWebServer }}
EXPOSE {{ .WebServerPort }}
{{- end }}
{{- if .InstallOllama }}
EXPOSE {{ .BackendPort }}
{{- end }}

# Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD wget -qO- http://localhost:{{ .APIPort }}/health || exit 1

# Use entrypoint for backend management
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]
