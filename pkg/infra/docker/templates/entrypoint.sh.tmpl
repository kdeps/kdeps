#!/bin/bash
set -e

echo "=== KDeps Docker Container Starting ==="
{{- if .InstallOllama }}
echo "Ollama enabled on port: ${BACKEND_PORT:-11434}"
{{- else }}
echo "No local LLM backend installed"
{{- end }}

{{- if .InstallOllama }}
# Function to wait for Ollama to be ready
wait_for_ollama() {
    local port=$1
    local max_attempts=30
    local attempt=0

    echo "Waiting for Ollama to be ready on port $port..."

    while [ $attempt -lt $max_attempts ]; do
        if curl -s http://localhost:$port/api/tags >/dev/null 2>&1; then
            echo "Ollama is ready!"
            return 0
        fi
        attempt=$((attempt + 1))
        echo "Attempt $attempt/$max_attempts: Ollama not ready yet..."
        sleep 2
    done

    echo "WARNING: Ollama did not become ready after $max_attempts attempts"
    return 1
}
{{- end }}

# Handle models based on offline mode
{{- if and .OfflineMode .Models .InstallOllama }}
if [ -d "/llm/models" ]; then
    echo "Offline mode: Copying pre-downloaded models to Ollama directory..."

    # OLLAMA_MODELS points to the models dir (default: /root/.ollama/models)
    MODELS_DIR="${OLLAMA_MODELS:-/root/.ollama/models}"
    mkdir -p "$MODELS_DIR"
    rsync -avrPtz --human-readable /llm/models/. "$MODELS_DIR/" || \
    cp -r /llm/models/* "$MODELS_DIR/" 2>/dev/null || true
    echo "Ollama models copied successfully"
else
    echo "WARNING: No pre-downloaded Ollama models found in /llm/models"
fi
{{- else if and .Models .InstallOllama }}
# Download models if specified (not in offline mode)
echo "Pre-pulling Ollama models..."

# Start Ollama temporarily in the background if it's not already running
# so we can pull models during the entrypoint phase.
if ! curl -s http://localhost:${BACKEND_PORT:-11434}/api/tags >/dev/null 2>&1; then
    echo "Starting Ollama server temporarily for model pulling..."
    /usr/local/bin/ollama serve > /tmp/ollama_entrypoint.log 2>&1 &
    TEMP_OLLAMA_PID=$!
    wait_for_ollama ${BACKEND_PORT:-11434}
fi

{{- range .Models }}
/usr/local/bin/ollama pull {{ . }} || echo "Failed to pull {{ . }}, will retry at runtime"
{{- end }}

# Kill the temporary Ollama process if we started one
if [ ! -z "$TEMP_OLLAMA_PID" ]; then
    echo "Stopping temporary Ollama server..."
    kill $TEMP_OLLAMA_PID || true
    sleep 2
fi
{{- end }}

# Execute the command passed to docker run
exec "$@"
