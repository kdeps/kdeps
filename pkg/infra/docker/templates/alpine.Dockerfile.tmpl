FROM {{ .BaseImage }}

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PATH=/opt/venv/bin:$PATH \
    {{- if .InstallOllama }}
    OLLAMA_HOST=127.0.0.1 \
    OLLAMA_PORT={{ .BackendPort }} \
    {{- end }}
    BACKEND_PORT={{ .BackendPort }}

# Install base dependencies
RUN apk add --no-cache \
    zstd \
    python3 \
    py3-pip \
    curl \
    bash \
    supervisor \
    ca-certificates \
    libstdc++ \
    rsync

# Install kdeps
RUN curl -LsSf https://raw.githubusercontent.com/kdeps/kdeps/main/install.sh | sh -s -- -b /usr/local/bin

{{- if .OSPackages }}

# Install OS packages
RUN apk add --no-cache{{ range .OSPackages }} {{ . }}{{ end }}
{{- end }}

# Install LLM backend
{{ .BackendInstall }}

# Install uv for Python package management
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Create virtual environment
RUN uv venv /opt/venv

{{- if .PythonPackages }}

# Install Python packages
RUN uv pip install{{ range .PythonPackages }} {{ . }}{{ end }}
{{- end }}

{{- if .RequirementsFile }}

# Install from requirements file
COPY {{ .RequirementsFile }} /tmp/requirements.txt
RUN uv pip install -r /tmp/requirements.txt
{{- end }}

# Copy workflow files
COPY workflow.yaml /app/workflow.yaml
{{- if .HasResources }}
COPY resources/ /app/resources/
{{- end }}
{{- if .HasData }}
COPY data/ /app/data/
{{- end }}

# Copy entrypoint and supervisor config
COPY entrypoint.sh /entrypoint.sh
COPY supervisord.conf /etc/supervisord.conf
RUN chmod +x /entrypoint.sh

# Ensure log directory exists
RUN mkdir -p /var/log

{{- if and .OfflineMode .Models .InstallOllama }}

# Download models during build time for offline mode
RUN mkdir -p /models

# Download Ollama models
RUN (OLLAMA_HOST=127.0.0.1 ollama serve &) && \
    sleep 10 && \
    {{- range $i, $model := .Models }}{{ if $i }} && \{{ end }}
    OLLAMA_HOST=127.0.0.1 ollama pull {{ $model }}{{ end }} && \
    pkill -f ollama && \
    sleep 2 && \
    # Copy to the image layer
    cp -r /root/.ollama/* /models/
{{- end }}

WORKDIR /app

# Expose ports
EXPOSE {{ .APIPort }} {{ .BackendPort }}

# Use entrypoint for backend management
ENTRYPOINT ["/entrypoint.sh"]
CMD ["supervisord", "-c", "/etc/supervisord.conf"]
